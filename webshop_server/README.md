# Webshop Server
This is the back-end for the webshop project. It is written in [Rust](https://www.rust-lang.org/), using the [Actix](https://actix.rs/) framework. We used [SQLx](https://crates.io/crates/sqlx) for database access and [PostgreSQL](https://www.postgresql.org/) for the database itself.

## How to build and run
First of all, you will need to have Rust and Cargo installed. You can install them by following the instructions on [rustup.rs](https://rustup.rs/).  
In addition you will need a PostgreSQL database running. We recommend using [Docker](https://docs.docker.com/get-docker/) to run the database. You will also need to create the database schema. Refer to [database README](../database/README.md) for more information.


Since we're using [SQLx](https://crates.io/crates/sqlx), you *need* a live database in order to compile, because the SQL queries are compile-time checked. If you however need to compile without a live database, see [Build with no database](#build-with-no-database).

### Environmental variables
You can put all environmental variables inside a `.env` file at the root of the Rust project directory (this directory).  

#### Environmental variable needed to build
```bash
# Database URL
DATABASE_URL=postgresql://user:password@url/db_name
# Or if you have no live database
SQLX_OFFLINE=true

# Optional, default is `resources/images` (relative path)
RESOURCES_DIR="/resources/images"
```
**Note:** `RESOURCES_DIR` env variable is useful if you need to specify an absolute path to the resources directory. We use it when building the Docker image.
#### Environmental variable needed to run
```bash
DATABASE_URL=postgresql://user:password@url/db_name
HOST=localhost # optionbal, default 'localhost'
PORT=8080 # optional, default '8080'
ALLOWED_ORIGINS=https://group04.web-tek.ninja # list of allowed origins, separated `,`
CERT_PATH=certificate.pem # path to certificate
PRIV_KEY_PATH=privatekey.pem # path to privatekey
```

### Building
To build the project, run the following command:
```bash
cargo build --release
```
On build, the script [`build.rs`](./build.rs) will include contents of `../webshop_frontend/dist` directory into the binary. `inddex.html` will be served on any request that doesn't match backend routes. Make sure to build the frontend before building the backend. For more information, refer to [webshop_frontend](../webshop_frontend/README.md).  

**Note:** If `dist` directory is not present, a release build **will fail**. Dev build will work fine, but `index.html` will be a dummy html file generated by the build script.

### Running
To run the project, you can run the generated binary:
```bash
./target/release/webshop_server
```
Or you can use cargo:
```bash
cargo run --release
```
You can also run a dev build:
```bash
cargo run
```
Regardless of the way you choose to run, you will need the following:
- PostgreSQL database running, with the database schema created. Refer to [database README](../database/README.md) for more information.
- SSL certificate and private key.
- Environmental variables set. Refer to [environmental variables to run](#environmental-variable-needed-to-run).

### Build with no database
If you need to build the project without a live database, [`sqlx-data.json`](./sqlx-data.json) file must be present in the root directory of the Rust project (this directory). This file must be [regenerated](#regenerating-sqlx-datajson) if the database schema or queries change. You will also need to set `SQLX_OFFLINE` environmental variable to `true`. You can do this in a `.env` file, or by setting the environmental variable in your shell.

### Regenerating sqlx-data.json
[`sqlx-data.json`](./sqlx-data.json) must be regenerated if the database schema or queries change.  
You will need [SQLx CLI](https://github.com/launchbadge/sqlx/blob/main/sqlx-cli/README.md), you can install it using cargo. Follow instructions on [SQLx CLI](https://github.com/launchbadge/sqlx/blob/main/sqlx-cli/README.md#install).  
In order to regenerate [sqlx-data.json](./sqlx-data.json), run the following command:
```bash
cargo sqlx prepare
```
**Note:** You will need to have a database running in order to regenerate [sqlx-data.json](./sqlx-data.json)!